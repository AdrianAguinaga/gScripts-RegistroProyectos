<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('CSS'); ?>
  <style>
    :root {
      --verde-uabc: #1C6B3C;
      --amarillo-uabc: #FFB800;
      --verde-claro: #c8e6c9;
      --blanco: #ffffff;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: var(--verde-uabc);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    .contenedor-principal {
      max-width: 900px;
      margin: 30px auto;
      background: var(--blanco);
      padding: 30px 40px;
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }

    .loader {
      border: 5px solid var(--verde-claro);
      border-top: 5px solid var(--amarillo-uabc);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="contenedor-principal" id="main-content">
    <div class="loader"></div>
  </div>

  <script>
    const currentProjectId = "<?= idProyecto ?>";
    document.addEventListener('DOMContentLoaded', () => {
      if (!currentProjectId) {
        alert("No se especific√≥ un ID del proyecto.");
        return;
      }

      const mainContent = document.getElementById('main-content');
      const loader = document.querySelector('.loader');

      google.script.run
        .withSuccessHandler(proyecto => {
          loader.remove();
          mainContent.innerHTML = `
            <h2>üìå Proyecto: ${proyecto.titulo}</h2>
            <div>
              <p><strong>Nombre del proponente:</strong> ${proyecto.nombre}</p>
              <p><strong>Matr√≠cula:</strong> ${proyecto.matricula}</p>
              <p><strong>Email:</strong> ${proyecto.email}</p>
              <p><strong>Carrera:</strong> ${proyecto.carrera}</p>
              <p><strong>Semestre:</strong> ${proyecto.semestre}</p>
              <p><strong>Estado actual:</strong> ${proyecto.estado}</p>
            </div>

            <div>
              <label><strong>Cambiar Estado:</strong></label>
              <select id="estado">
                <option>Aprobado</option>
                <option>Iniciado</option>
                <option>En Dise√±o</option>
                <option>Desarrollo</option>
                <option>Pruebas</option>
                <option>Finalizado</option>
                <option>Cancelado</option>
                <option>Detenido</option>
              </select>
              <button onclick="cambiarEstado()">Guardar Estado</button>
            </div>

            <div>
              <label><strong>Agregar Nota:</strong></label>
              <textarea id="nota"></textarea>
              <button onclick="agregarNota()">Guardar Nota</button>
            </div>

            <div>
              <label><strong>Repositorio GitHub:</strong></label>
              <input type="url" id="repositorio" value="${proyecto.repositorio}">
              <button onclick="guardarRepositorio()">Guardar Repositorio</button>
            </div>

            <div style="margin-top:20px;text-align:center;">
              <a class="boton-uabc" href="<?= baseUrl ?>?page=propuestas">‚Üê Regresar a proyectos aprobados</a>
            </div>
          `;

          document.getElementById('estado').value = proyecto.estado;

        })
        .withFailureHandler(error => {
          loader.remove();
          mainContent.innerHTML = `
            <div style="color:red;">
              Error al cargar datos del proyecto: ${error.message}
            </div>
          `;
        })
        .obtenerDatosProyecto(currentProjectId);
    });

    function cambiarEstado() {
      const nuevoEstado = document.getElementById('estado').value;
      google.script.run
        .withSuccessHandler(() => alert("Estado actualizado correctamente."))
        .withFailureHandler(error => alert("Error al actualizar estado: " + error.message))
        .cambiarEstadoProyecto(currentProjectId, nuevoEstado);
    }

    function agregarNota() {
      const texto = document.getElementById('nota').value;
      google.script.run
        .withSuccessHandler(() => {
          alert("Nota agregada correctamente.");
          document.getElementById('nota').value = '';
        })
        .withFailureHandler(error => alert("Error al agregar nota: " + error.message))
        .agregarNotaProyecto(currentProjectId, texto);
    }

    function guardarRepositorio() {
      const link = document.getElementById('repositorio').value;
      google.script.run
        .withSuccessHandler(() => alert("Repositorio guardado correctamente."))
        .withFailureHandler(error => alert("Error al guardar repositorio: " + error.message))
        .guardarRepositorioProyecto(currentProjectId, link);
    }
  </script>
</body>
</html>
