<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include("CSS"); ?>
  <?!= include("Utils"); ?>
  <?!= include("Components"); ?>

  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .grid-item {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--sombra);
      height: 400px;
      overflow: auto;
    }

    select {
      padding: 10px;
      border-radius: 8px;
      width: 100%;
      font-size: 16px;
    }
  </style>
</head>
<body>
<div class="contenedor-principal">
  <h2>📈 Estadísticas de Proyectos</h2>
  
  <div class="grid-container">
    <!-- Cuadrante 1: Selección del proyecto -->
    <div class="grid-item">
      <h3>📌 Seleccionar Proyecto</h3>
      <select id="selectorProyectos" onchange="mostrarAvanceProyecto()">
        <option value="">Selecciona un proyecto</option>
      </select>
    </div>

    <!-- Cuadrante 2: Avance del proyecto seleccionado -->
    <div class="grid-item">
      <h3>🚧 Avance del Proyecto</h3>
      <div id="avanceProyecto">
        <em>Selecciona un proyecto para ver su avance.</em>
      </div>
    </div>

    <!-- Cuadrante 3: Resumen histórico -->
    <div class="grid-item">
      <h3>📅 Histórico de Propuestas</h3>
      <div id="graficaHistoricoPropuestas"></div>
    </div>

    <!-- Cuadrante 4: Histórico general -->
    <div class="grid-item">
      <h3>📊 Histórico General de Avances</h3>
      <div id="graficaGeneralAvances"></div>
    </div>
  </div>
</div>

<script>
google.charts.load('current', {packages: ['corechart']});
google.charts.setOnLoadCallback(iniciarPagina);

let proyectosData = [];

function iniciarPagina() {
  google.script.run.withSuccessHandler(function(proyectos) {
    proyectosData = proyectos;
    const selector = document.getElementById('selectorProyectos');
    proyectos.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = p.titulo;
      selector.appendChild(option);
    });

    dibujarGraficaHistorico(proyectos);
    dibujarGraficaGeneralAvances(proyectos);
  }).obtenerTodosLosProyectos();
}

function mostrarAvanceProyecto() {
  const id = document.getElementById('selectorProyectos').value;
  const contenedor = document.getElementById('avanceProyecto');
  
  if (!id) {
    contenedor.innerHTML = "<em>Selecciona un proyecto para ver su avance.</em>";
    return;
  }

  const proyecto = proyectosData.find(p => p.id === id);
  const historial = JSON.parse(proyecto.historial);

  let contenido = `<strong>Estado actual:</strong> ${proyecto.estado}<br><br>`;
  contenido += '<ul>';
  historial.forEach(h => {
    contenido += `<li><strong>${h.estado}</strong> - ${new Date(h.fecha).toLocaleDateString()}</li>`;
  });
  contenido += '</ul>';

  contenedor.innerHTML = contenido;
}

function dibujarGraficaHistorico(proyectos) {
  const resumen = proyectos.reduce((acc, p) => {
    acc.total += 1;
    if (p.estado === "Aprobado") acc.aprobados += 1;
    else if (p.estado === "Rechazado") acc.rechazados += 1;
    else if (p.estado === "Pendiente") acc.pendientes += 1;
    return acc;
  }, {total:0, aprobados:0, rechazados:0, pendientes:0});

  const data = google.visualization.arrayToDataTable([
    ['Estado', 'Cantidad'],
    ['Aprobados', resumen.aprobados],
    ['Rechazados', resumen.rechazados],
    ['Pendientes', resumen.pendientes]
  ]);

  const options = {
    pieHole: 0.4,
    colors: ['#4caf50', '#f44336', '#ff9800']
  };

  const chart = new google.visualization.PieChart(document.getElementById('graficaHistoricoPropuestas'));
  chart.draw(data, options);
}

function dibujarGraficaGeneralAvances(proyectos) {
  const estados = ["Pendiente", "Aprobado", "Iniciado", "En Diseño", "Desarrollo", "Pruebas", "Finalizado", "Cancelado", "Detenido"];
  const resumenEstados = estados.reduce((acc, estado) => ({ ...acc, [estado]: 0 }), {});

  proyectos.forEach(p => {
    resumenEstados[p.estado] = (resumenEstados[p.estado] || 0) + 1;
  });

  const data = [['Estado', 'Cantidad']];
  estados.forEach(e => data.push([e, resumenEstados[e]]));

  const dataTable = google.visualization.arrayToDataTable(data);

  const options = {
    legend: { position: 'none' },
    colors: ['#9e9e9e', '#4caf50', '#2196f3', '#ffeb3b', '#03a9f4', '#673ab7', '#8bc34a', '#f44336', '#ff5722'],
    bars: 'horizontal'
  };

  const chart = new google.visualization.BarChart(document.getElementById('graficaGeneralAvances'));
  chart.draw(dataTable, options);
}

window.addEventListener('resize', () => {
  dibujarGraficaHistorico(proyectosData);
  dibujarGraficaGeneralAvances(proyectosData);
});
</script>
</body>
</html>
